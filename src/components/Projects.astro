---
import { projects } from '../data/projects';

const filters = [
  { key: 'all', label: 'Todos' },
  { key: 'next', label: 'Next.js' },
  { key: 'react', label: 'React' },
  { key: 'astro', label: 'Astro' },
  { key: 'js', label: 'JavaScript' },
  { key: 'typescript', label: 'TypeScript' },
  { key: 'tailwind', label: 'Tailwind' },
  { key: 'php', label: 'PHP' },
  { key: 'node', label: 'Node' },
  { key: 'mysql', label: 'MySQL' },
  { key: 'mongodb', label: 'MongoDB' },
  { key: 'supabase', label: 'Supabase' },
  { key: 'firebase', label: 'Firebase' },
  { key: 'sass', label: 'SASS' },
];

const projectsJson = JSON.stringify(
  projects.map(({ title, shortDesc, fullDesc, image, tags, filterTags, status, github, githubFE, githubBE, demo }) => ({
    title, shortDesc, fullDesc, image, tags, filterTags, status, github, githubFE, githubBE, demo,
  }))
);
---

<section id="portfolio" class="py-24 bg-gray-50 dark:bg-surface-dark-card">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">

    <h2 class="section-title reveal">Proyectos</h2>

    <!-- Filter buttons -->
    <div class="reveal flex flex-wrap justify-center gap-2 mb-12">
      {filters.map(f => (
        <button
          class="filter-btn px-4 py-2 rounded-xl text-sm font-medium transition-all duration-200
                 border border-gray-300 dark:border-gray-600 text-gray-600 dark:text-gray-400
                 hover:border-accent hover:text-accent dark:hover:border-accent dark:hover:text-accent"
          data-filter={f.key}
        >
          {f.label}
        </button>
      ))}
    </div>

    <!-- Project grid -->
    <div id="projects-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
      {projects.map((project, i) => (
        <div
          class="project-card reveal group flex flex-col rounded-2xl overflow-hidden
                 bg-white dark:bg-surface-dark
                 border border-gray-200 dark:border-surface-dark-border
                 hover:border-accent/50 hover:shadow-xl hover:shadow-accent/10
                 hover:-translate-y-1 transition-all duration-300"
          data-filter-tags={project.filterTags.join(' ')}
          data-index={String(i)}
        >
          <!-- Image -->
          <div class="relative overflow-hidden aspect-video bg-gray-100 dark:bg-gray-800">
            <img
              src={project.image}
              alt={project.title}
              loading="lazy"
              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
              onerror="this.style.display='none';this.parentElement.querySelector('.img-fallback').style.display='flex'"
            />
            <!-- Fallback shown when image is missing -->
            <div class="img-fallback hidden w-full h-full absolute inset-0 items-center justify-center
                        bg-gradient-to-br from-accent/20 to-accent/5">
              <i class="iconoir-code-brackets-square text-4xl text-accent/40"></i>
            </div>
            <!-- Tags overlay -->
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent
                        opacity-0 group-hover:opacity-100 transition-opacity duration-300
                        flex items-end p-3 gap-1.5 flex-wrap">
              {project.tags.slice(0, 3).map(tag => (
                <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-accent text-white shadow">
                  {tag}
                </span>
              ))}
            </div>
          </div>

          <!-- Content -->
          <div class="flex flex-col flex-1 p-4">
            <div class="flex items-start justify-between gap-2 mb-2">
              <h4 class="font-bold text-gray-800 dark:text-white text-sm leading-snug">{project.title}</h4>
              <span class="flex-shrink-0 text-xs font-semibold px-2 py-0.5 rounded-full bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">
                {project.status}
              </span>
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed flex-1 mb-3">
              {project.shortDesc}
            </p>

            <!-- Actions -->
            <div class="flex items-center gap-1.5 flex-wrap">
              {project.githubFE && (
                <a href={project.githubFE} target="_blank" rel="noopener"
                   class="action-icon" title="Repositorio Frontend" aria-label="GitHub Frontend">
                  <i class="iconoir-github text-base"></i>
                  <span class="text-xs">FE</span>
                </a>
              )}
              {project.githubBE && (
                <a href={project.githubBE} target="_blank" rel="noopener"
                   class="action-icon" title="Repositorio Backend" aria-label="GitHub Backend">
                  <i class="iconoir-github text-base"></i>
                  <span class="text-xs">BE</span>
                </a>
              )}
              {project.github && !project.githubFE && (
                <a href={project.github} target="_blank" rel="noopener"
                   class="action-icon" title="Ver código" aria-label="GitHub">
                  <i class="iconoir-github text-base"></i>
                </a>
              )}
              {project.demo && (
                <a href={project.demo} target="_blank" rel="noopener"
                   class="action-icon" title="Ver sitio" aria-label="Demo">
                  <i class="iconoir-internet text-base"></i>
                </a>
              )}
              <button
                class="proj-more-btn ml-auto text-xs font-semibold text-accent
                       hover:underline transition-colors"
                data-index={String(i)}
                aria-haspopup="dialog"
              >
                Ver más
              </button>
            </div>
          </div>
        </div>
      ))}
    </div>

    <!-- No results message -->
    <p id="no-results" class="hidden text-center text-gray-500 dark:text-gray-400 mt-8">
      No hay proyectos para este filtro.
    </p>

  </div>
</section>

<!-- Project Modal -->
<div id="proj-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-box">
    <button id="proj-modal-close"
      class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center
             rounded-lg text-gray-400 hover:text-gray-700 dark:hover:text-white
             hover:bg-gray-100 dark:hover:bg-gray-700 transition-all"
      aria-label="Cerrar">
      <i class="iconoir-cancel text-lg"></i>
    </button>
    <img id="proj-modal-img" src="" alt="" class="w-full rounded-xl mb-4 object-cover max-h-48" />
    <h3 id="proj-modal-title" class="text-xl font-bold text-gray-800 dark:text-white mb-2 pr-8"></h3>
    <p id="proj-modal-desc" class="text-gray-600 dark:text-gray-400 text-sm leading-relaxed mb-4"></p>
    <div id="proj-modal-tags" class="flex flex-wrap gap-2 mb-4"></div>
    <div id="proj-modal-links" class="flex flex-wrap gap-2"></div>
  </div>
</div>

<!-- Embedded data -->
<script type="application/json" id="proj-data" set:html={projectsJson}></script>

<style>
  .action-icon {
    @apply flex items-center gap-0.5 px-2 py-1.5 rounded-lg text-gray-500 dark:text-gray-400
           hover:text-accent dark:hover:text-accent hover:bg-accent/10
           border border-transparent hover:border-accent/20
           transition-all duration-200;
  }

  .filter-btn.active {
    @apply bg-accent text-white border-accent;
  }

  .project-card.hidden-card {
    display: none;
  }
</style>

<script>
  // ─── Data ─────────────────────────────────────────────────
  interface ProjectData {
    title: string; shortDesc: string; fullDesc: string; image: string;
    tags: string[]; filterTags: string[]; status: string;
    github?: string; githubFE?: string; githubBE?: string; demo?: string;
  }
  const projects: ProjectData[] = JSON.parse(
    document.getElementById('proj-data')?.textContent ?? '[]'
  );

  // ─── Filter ───────────────────────────────────────────────
  const filterBtns = document.querySelectorAll<HTMLButtonElement>('.filter-btn');
  const projectCards = document.querySelectorAll<HTMLElement>('.project-card');
  const noResults = document.getElementById('no-results')!;
  let activeFilter = 'all';

  function applyFilter(filter: string) {
    activeFilter = filter;
    let visible = 0;
    projectCards.forEach(card => {
      const tags = card.dataset.filterTags ?? '';
      const show = filter === 'all' || tags.split(' ').includes(filter);
      card.classList.toggle('hidden-card', !show);
      if (show) visible++;
    });
    noResults.classList.toggle('hidden', visible > 0);
    filterBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.filter === filter));
  }

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => applyFilter(btn.dataset.filter ?? 'all'));
  });

  applyFilter('all');

  // ─── Project modal ────────────────────────────────────────
  const modal = document.getElementById('proj-modal')!;
  const modalImg = document.getElementById('proj-modal-img') as HTMLImageElement;
  const modalTitle = document.getElementById('proj-modal-title')!;
  const modalDesc = document.getElementById('proj-modal-desc')!;
  const modalTags = document.getElementById('proj-modal-tags')!;
  const modalLinks = document.getElementById('proj-modal-links')!;
  const closeBtn = document.getElementById('proj-modal-close')!;

  function openProjModal(index: number) {
    const p = projects[index];
    if (!p) return;
    modalImg.src = p.image;
    modalImg.alt = p.title;
    modalTitle.textContent = p.title;
    modalDesc.textContent = p.fullDesc;
    modalTags.innerHTML = p.tags
      .map(t => `<span class="chip">${t}</span>`)
      .join('');

    const links: string[] = [];
    if (p.githubFE) links.push(`<a href="${p.githubFE}" target="_blank" rel="noopener"
      class="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl bg-gray-800 text-white text-sm font-medium hover:bg-gray-700 transition-colors">
      <i class="iconoir-github"></i> GitHub FE</a>`);
    if (p.githubBE) links.push(`<a href="${p.githubBE}" target="_blank" rel="noopener"
      class="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl bg-gray-800 text-white text-sm font-medium hover:bg-gray-700 transition-colors">
      <i class="iconoir-github"></i> GitHub BE</a>`);
    if (p.github && !p.githubFE) links.push(`<a href="${p.github}" target="_blank" rel="noopener"
      class="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl bg-gray-800 text-white text-sm font-medium hover:bg-gray-700 transition-colors">
      <i class="iconoir-github"></i> GitHub</a>`);
    if (p.demo) links.push(`<a href="${p.demo}" target="_blank" rel="noopener"
      class="inline-flex items-center gap-1.5 px-4 py-2 rounded-xl bg-accent text-white text-sm font-medium hover:bg-accent-dark transition-colors">
      <i class="iconoir-internet"></i> Ver sitio</a>`);
    modalLinks.innerHTML = links.join('');

    modal.classList.add('open');
    modal.setAttribute('aria-hidden', 'false');
    document.body.classList.add('modal-open');
  }

  function closeProjModal() {
    modal.classList.remove('open');
    modal.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('modal-open');
  }

  document.querySelectorAll<HTMLButtonElement>('.proj-more-btn').forEach(btn => {
    btn.addEventListener('click', () => openProjModal(Number(btn.dataset.index)));
  });
  closeBtn.addEventListener('click', closeProjModal);
  modal.addEventListener('click', e => { if (e.target === modal) closeProjModal(); });
  document.addEventListener('keydown', e => { if (e.key === 'Escape') closeProjModal(); });
</script>
